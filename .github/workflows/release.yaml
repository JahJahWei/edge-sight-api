name: Release Private SDKs

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  packages: write

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout API Repo
        uses: actions/checkout@v4

      - name: Extract Version
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Install Buf
        run: |
          echo "Installing Buf"
          curl -sSL https://github.com/bufbuild/buf/releases/latest/download/buf-$(uname -s)-$(uname -m) -o /usr/local/bin/buf
          chmod +x /usr/local/bin/buf
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          registry-url: "https://npm.pkg.github.com"
      
      - name: Setup go
        uses: actions/setup-go@v4
        with:
          go-version: "1.24"
      
      - name: Generate Meta SDK
        run: |
          echo "Generating Meta SDK"
          cd meta
          buf generate

      - name: Push Meta Java SDK
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          echo "Pushing Meta Java SDK"
          
          # Define variables
          VERSION=${{ steps.version.outputs.version }}
          REPO_NAME="meta-api-sdk-java"
          REPO_URL="https://x-access-token:${GH_TOKEN}@github.com/JahJahWei/${REPO_NAME}.git"
          SOURCE_DIR="meta/gen/${REPO_NAME}"
          
          # Clone the repository
          echo "Cloning ${REPO_NAME} repository..."
          git clone "${REPO_URL}"
          cd "${REPO_NAME}"
          
          # Configure git
          git config user.name github-actions
          git config user.email github-actions@github.com

          # Clean existing generated files (optional, for clean state)
          echo "Cleaning existing generated files..."
          rm -rf src/main/java/* 2>/dev/null || true
          
          # Copy generated files
          echo "Copying generated files from ${SOURCE_DIR}..."
          if [ -d "../${SOURCE_DIR}" ]; then
            cp -r "../${SOURCE_DIR}"/* src/main/java/
          else
            echo "Error: Source directory ../${SOURCE_DIR} not found!"
            exit 1
          fi

          # Add all files
          git add .

          # Commit changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Sync Meta API Java SDK v${VERSION}"
          fi

          # Create tag (ignore if already exists)
          git tag "v${VERSION}" 2>/dev/null || echo "Tag v${VERSION} already exists"

          # Push changes and tags
          echo "Pushing changes to repository..."
          git push origin master --tags || {
            echo "Push failed, trying to pull and merge first"
            git pull origin master --allow-unrelated-histories --no-edit || echo "Pull failed"
            git push origin master --tags || {
              echo "Push still failed, trying force push"
              git push origin master --tags --force
            }
          }

          # Deploy to Maven repository
          echo "Deploying to Maven repository..."
          mvn clean deploy -DskipTests -s settings.xml
      
      - name: Push Meta Go SDK
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          echo "Pushing Meta Go SDK"
          
          # Define variables
          VERSION=${{ steps.version.outputs.version }}
          REPO_NAME="meta-api-sdk-go"
          REPO_URL="https://x-access-token:${GH_TOKEN}@github.com/JahJahWei/${REPO_NAME}.git"
          SOURCE_DIR="meta/gen/${REPO_NAME}"
          
          # Clone the repository
          echo "Cloning ${REPO_NAME} repository..."
          git clone "${REPO_URL}" "${REPO_NAME}"
          cd "${REPO_NAME}"
          
          # Configure git
          git config user.name github-actions
          git config user.email github-actions@github.com

          # Copy generated files
          echo "Copying generated files from ${SOURCE_DIR}..."
          if [ -d "../${SOURCE_DIR}" ]; then
            cp -r "../${SOURCE_DIR}"/* .
          else
            echo "Error: Source directory ../${SOURCE_DIR} not found!"
            exit 1
          fi

          # Create go.mod if it doesn't exist
          if [ ! -f go.mod ]; then
            echo "Creating go.mod file..."
            cat > go.mod << EOF
module github.com/JahJahWei/meta-api-sdk-go

go 1.24

require (
	google.golang.org/grpc v1.59.0
	google.golang.org/protobuf v1.31.0
)
EOF
          fi

          # Create README.md if it doesn't exist
          if [ ! -f README.md ]; then
            echo "Creating README.md file..."
            cat > README.md << EOF
# Meta API Go SDK

Go SDK for Meta API generated from Protocol Buffers.

## Installation

\`\`\`bash
go get github.com/JahJahWei/meta-api-sdk-go@v${VERSION}
\`\`\`
EOF
          fi

          # Add all files
          git add .

          # Commit changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Sync Meta API Go SDK v${VERSION}"
          fi

          # Create tag (ignore if already exists)
          git tag "v${VERSION}" 2>/dev/null || echo "Tag v${VERSION} already exists"

          # Push changes and tags
          echo "Pushing changes to repository..."
          git push origin master --tags || {
            echo "Push failed, trying to pull and merge first"
            git pull origin master --allow-unrelated-histories --no-edit || echo "Pull failed"
            git push origin master --tags || {
              echo "Push still failed, trying force push"
              git push origin master --tags --force
            }
          }

          # Set up Go module for publishing
          echo "Setting up Go module..."
          go mod tidy
          
          # Create a release for GitHub Packages
          echo "Creating GitHub release..."
          gh release create "v${VERSION}" --generate-notes --repo "JahJahWei/${REPO_NAME}" || echo "Release already exists"

